<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DG SAVINGS</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --primary: #474b50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --success: #2ecc71;
      --light-bg: #f5f7fa;
      --dark-bg: #1e1e1e;
      --card-bg: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #ecf0f1;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Dark theme variables */
    [data-theme="dark"] {
      --primary: #3498db;
      --secondary: #2ecc71;
      --light-bg: #1e1e1e;
      --dark-bg: #2c2c2c;
      --card-bg: #2c2c2c;
      --text-dark: #ecf0f1;
      --text-light: #bdc3c7;
      --shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* Purple theme variables */
    [data-theme="purple"] {
      --primary: #8e44ad;
      --secondary: #9b59b6;
      --accent: #e74c3c;
      --success: #2ecc71;
      --light-bg: #f5eef8;
      --dark-bg: #8e44ad;
      --card-bg: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #ffffff;
      --shadow: 0 4px 12px rgba(142, 68, 173, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Theme toggle button */
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 20px;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-options {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 5px;
      z-index: 99;
    }

    .theme-option {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: var(--light-bg);
      color: var(--text-dark);
    }

    .theme-option:hover {
      background: var(--secondary);
      color: white;
    }

    .theme-options.show {
      display: flex;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      color: var(--text-dark);
      line-height: 1.6;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--primary);
      color: var(--text-light);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .card h2 {
      margin-bottom: 15px;
      color: var(--primary);
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 10px;
    }

    .kpi-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    .kpi {
      flex: 1;
      min-width: 180px;
      text-align: center;
      padding: 15px;
      background: var(--light-bg);
      border-radius: var(--border-radius);
    }

    .kpi-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 10px 0;
    }

    .kpi-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .positive {
      color: var(--success);
    }

    .negative {
      color: var(--accent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, button, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    button, .btn {
      background: var(--secondary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      text-align: center;
      display: inline-block;
      text-decoration: none;
    }

    button:hover, .btn:hover {
      background: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: var(--primary);
      color: white;
    }

    tr:nth-child(even) {
      background: var(--light-bg);
    }

    .chart-container {
      position: relative;
      height: 250px;
      width: 100%;
    }

    .progress-bar {
      background: #e0e0e0;
      border-radius: 5px;
      height: 20px;
      margin-top: 5px;
      overflow: hidden;
    }

    .progress {
      background: var(--success);
      height: 100%;
      border-radius: 5px;
      text-align: right;
      padding-right: 5px;
      font-size: 12px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .goal-item {
      margin-bottom: 15px;
      padding: 10px;
      background: var(--light-bg);
      border-radius: 8px;
    }

    .download-options {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .download-btn {
      padding: 15px 30px;
      font-size: 1.1rem;
      min-width: 250px;
      text-align: center;
    }

    .btn-monthly {
      background: var(--success);
    }

    .btn-yearly {
      background: var(--accent);
    }

    /* Νέες προσθήκες για κουμπιά διαχείρισης */
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .btn-delete {
      background: var(--accent);
      padding: 5px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
    }

    .btn-move {
      background: var(--primary);
      padding: 5px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
    }

    /* Στυλ για το νέο τμήμα δανείων */
    .loans-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .loan-section {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--shadow);
    }

    .loan-form {
      margin-bottom: 15px;
    }

    .loan-form input {
      display: block;
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .loan-form button {
      background-color: var(--success);
      color: var(--text-light);
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .loan-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--primary);
      padding: 10px;
      border-radius: 4px;
    }

    .loan-item {
      padding: 8px;
      border-bottom: 1px solid var(--primary);
    }

    .loan-item:last-child {
      border-bottom: none;
    }

    /* Βελτιωμένα fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    /* Βελτιωμένα cards */
    .card {
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    /* Βελτιωμένα κουμπιά */
    button, .btn {
    border-radius: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    }

    button:after, .btn:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
    }

    button:hover:after, .btn:hover:after {
    animation: ripple 0.6s ease-out;
    }

    @keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
    }
    /* Στυλ για το κουμπί απόκρυψης */
    .privacy-toggle {
        position: absolute;
        top: 20px;
        right: 80px;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 20px;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.3s ease;
    }

    .privacy-toggle:hover {
        transform: scale(1.1);
    }

    /* Κλάση για το blur effect */
    .blur-numbers {
        filter: blur(5px);
        transition: filter 0.3s ease;
        user-select: none;
        pointer-events: none;
    }

    /* Responsive adjustment */
    @media (max-width: 768px) {
        .privacy-toggle {
            right: 70px;
            width: 40px;
            height: 40px;
        }
    }

    /* Βελτιωμένα input fields */
    input, select {
    transition: all 0.2s ease;
    border: 1px solid #ddd;
    background-color: rgba(255, 255, 255, 0.8);
    }

    input:focus, select:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Βελτιωμένος πίνακας */
    table {
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    }

    th {
    font-weight: 600;
    letter-spacing: 0.5px;
    }

    /* Smooth animations για charts */
    .chart-container {
    transition: opacity 0.3s ease;
    }

    /* Loading state */
    .loading {
    opacity: 0.7;
    pointer-events: none;
    }

    /* Progress bars */
    .progress {
    transition: width 0.5s ease-in-out;
    }

    /* Header improvements */
    header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    position: relative;
    overflow: hidden;
    }

    header:before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
    }
    /* Προσθήκη στο τέλος του CSS */
    .blur-numbers {
        color: transparent !important;
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
    }

    /* Διασφάλιση ότι τα εικονίδια δεν θα θολώνουν */
    .privacy-toggle, .theme-toggle {
        filter: none !important;
    }


    /* KPI cards */
    .kpi {
    transition: all 0.3s ease;
    border-left: 3px solid var(--secondary);
    }

    .kpi:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Notification toast */
    .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    background: var(--success);
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    }

    .toast.show {
    transform: translateY(0);
    opacity: 1;
    }

    /* Tooltips */
    .tooltip {
    position: relative;
    cursor: pointer;
    }

    .tooltip:before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 12px;
    background: rgba(0,0,0,0.8);
    color: white;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 100;
    }

    .tooltip:hover:before {
    opacity: 1;
    visibility: visible;
    bottom: calc(100% + 5px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .kpi {
        min-width: 100%;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .download-options {
        flex-direction: column;
        align-items: center;
      }

      .action-buttons {
        flex-direction: column;
      }
      
      .loans-container {
        grid-template-columns: 1fr;
      }

      .theme-options {
        right: 10px;
      }
    }

    /* PDF specific styles */
    .pdf-template {
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .pdf-template h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
    }
    
    .pdf-template .period {
      text-align: center;
      margin-bottom: 30px;
      font-style: italic;
    }
    
    .pdf-template .summary {
      margin-bottom: 30px;
      padding: 15px;
      background: var(--light-bg);
      border-radius: var(--border-radius);
    }
    
    .pdf-template table {
      width: 100%;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
    .dashboard-container {
      padding: 10px;
    }
    
    header {
      padding: 15px;
    }
    
    h1 {
      font-size: 1.8rem;
    }
    
    .kpi-container {
      flex-direction: column;
    }
    
    .kpi {
      margin-bottom: 10px;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
      gap: 5px;
    }
    
    .action-buttons button {
      width: 100%;
    }
    
    /* Βελτίωση πίνακα για κινητά */
    table {
      font-size: 0.8rem;
    }
    
    th, td {
      padding: 8px 4px;
    }
    
    /* Loan sections stack on mobile */
    .loans-container {
      grid-template-columns: 1fr;
    }


  }    
  .goal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .goal-image{
      width: 32px;     /* από 72px */
      height: 32px;    /* από 72px */
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
    }

    .goal-meta {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .goal-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .goal-actions button {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 6px;
    }

    .btn-ghost {
      background: var(--light-bg);
      color: var(--text-dark);
    }
    /* AUTH overlay */
    .auth-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; align-items:center; justify-content:center;
      z-index:9000;
    }
    .auth-card{
      width:min(480px,92vw);
      background:var(--card-bg); color:var(--text-dark);
      border-radius:16px; box-shadow:var(--shadow); padding:22px;
    }
    .auth-card h2{ margin:0 0 8px; text-align:center; color:var(--primary); }
    .auth-tabs{ display:flex; gap:8px; margin:6px 0 14px; }
    .auth-tabs button{
      flex:1; padding:10px; border:1px solid #ddd; background:var(--light-bg);
      border-radius:8px; cursor:pointer; font-weight:600;
    }
    .auth-tabs button.active{ background:var(--secondary); color:#fff; border-color:transparent; }
    .auth-card form .form-row{ margin-bottom:10px; }
    .auth-card label{ font-weight:600; margin-bottom:4px; display:block; }
    .auth-card input{ width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; }
    .auth-actions{ display:flex; gap:10px; margin-top:8px; }

    /* Logout κουμπί στο header */
    .logout-btn{
      position:absolute; top:20px; right:140px;
      background:#ef4444; color:white; border:none; border-radius:20px;
      width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; z-index:100; transition:all .3s ease;
    }
    .logout-btn:hover{ transform:scale(1.1); }
  </style>
</head>
<body>
    <div id="loadingIndicator" class="loading" style="display: none;">
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: var(--shadow);">
        <div style="text-align: center;">Φόρτωση...</div>
        </div>
    </div>
    </div>

        <!-- AUTH overlay -->
    <div id="authOverlay" class="auth-overlay" style="display:flex">
      <div class="auth-card">
        <h2>DG | SAVINGS</h2>

        <div class="auth-tabs">
          <button id="tabLogin" class="active" type="button">Σύνδεση</button>
          <button id="tabSignup" type="button">Εγγραφή</button>
        </div>

        <form id="loginForm">
          <div class="form-row">
            <label>Όνομα χρήστη</label>
            <input id="loginUser" autocomplete="username" required />
          </div>
          <div class="form-row">
            <label>Κωδικός</label>
            <input id="loginPass" type="password" autocomplete="current-password" required />
          </div>
          <div class="auth-actions">
            <button class="btn" type="submit">Σύνδεση</button>
          </div>
        </form>

        <form id="signupForm" style="display:none">
          <div class="form-row">
            <label>Όνομα χρήστη</label>
            <input id="signupUser" autocomplete="username" required />
          </div>
          <div class="form-row">
            <label>Κωδικός</label>
            <input id="signupPass" type="password" autocomplete="new-password" required />
          </div>
          <div class="form-row">
            <label>Επανάληψη κωδικού</label>
            <input id="signupPass2" type="password" autocomplete="new-password" required />
          </div>
          <div class="auth-actions">
            <button class="btn" type="submit">Δημιουργία λογαριασμού</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Προσθήκη toast notifications -->
    <div id="toast" class="toast"></div>

    <!-- Βελτίωση header -->
    <div id="appRoot" style="display:none">
      <header>
          <h1>DG | SAVINGS</h1>
          <p class="subtitle">Διαχείριση Προσωπικών Οικονομικών</p>
          <button class="theme-toggle" id="themeToggle" title="Αλλαγή θέματος" data-tooltip="Αλλαγή θέματος">🎨</button>
          <button class="privacy-toggle" id="privacyToggle" title="Απόκρυψη δεδομένων" data-tooltip="Απόκρυψη δεδομένων">👁️</button>
          <button class="logout-btn" id="logoutBtn" title="Αποσύνδεση" data-tooltip="Αποσύνδεση">🚪</button>
          <div class="theme-options" id="themeOptions">
              <button class="theme-option" data-theme="light">light mode</button>
              <button class="theme-option" data-theme="dark">dark mode</button>
              <button class="theme-option" data-theme="purple">eve mode</button>
          </div>
      </header>

      <!-- KPIs -->
      <div class="grid">
        <div class="card">
          <h2>Σύνολο</h2>
          <div class="kpi-container">
            <div class="kpi">
              <div class="kpi-label">Συνολικό Πορτοφόλι</div>
              <div class="kpi-value" id="totalKPI">0€</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Μεταβολή</div>
              <div class="kpi-value" id="growthKPI">0%</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Cash %</div>
              <div class="kpi-value" id="cashKPI">0%</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Καθαρά Δάνεια</div>
              <div class="kpi-value" id="loansKPI">0€</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Φόρμα εισαγωγής δεδομένων -->
      <div class="card">
        <h2>Προσθήκη Νέων Δεδομένων</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="month">Μήνας</label>
            <select id="month">
              <option value="Ιανουάριος">Ιανουάριος</option>
              <option value="Φεβρουάριος">Φεβρουάριος</option>
              <option value="Μάρτιος">Μάρτιος</option>
              <option value="Απρίλιος">Απρίλιος</option>
              <option value="Μάιος">Μάιος</option>
              <option value="Ιούνιος">Ιούνιος</option>
              <option value="Ιούλιος">Ιούλιος</option>
              <option value="Αύγουστος">Αύγουστος</option>
              <option value="Σεπτέμβριος">Σεπτέμβριος</option>
              <option value="Οκτώβριος">Οκτώβριος</option>
              <option value="Νοέμβριος">Νοέμβριος</option>
              <option value="Δεκέμβριος">Δεκέμβριος</option>
            </select>
          </div>
          <div class="form-group">
            <label for="year">Έτος</label>
            <select id="year">
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cash">Cash (€)</label>
            <input type="number" id="cash" placeholder="0">
          </div>
          <div class="form-group">
            <label for="etoro">Etoro (€)</label>
            <input type="number" id="etoro" placeholder="0">
          </div>
          <div class="form-group">
            <label for="revolut">Revolut (€)</label>
            <input type="number" id="revolut" placeholder="0">
          </div>
          <div class="form-group">
            <label for="winbank">Winbank (€)</label>
            <input type="number" id="winbank" placeholder="0">
          </div>
          <div class="form-group">
            <label for="stocks">Stocks (€)</label>
            <input type="number" id="stocks" placeholder="0">
          </div>
          <div class="form-group">
            <label for="youthpass">Youth Pass (€)</label>
            <input type="number" id="youthpass" placeholder="0">
          </div>

        </div>
        <button onclick="addData()" style="margin-top: 15px;">Προσθήκη Δεδομένων</button>
      </div>

      <!-- Πίνακας δεδομένων -->
      <div class="card">
        <h2>Ιστορικό Δεδομένων</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <input type="text" id="searchInput" placeholder="Αναζήτηση..." style="flex: 1;">
          <select id="yearFilter">
          <option value="">Όλα τα έτη</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          </select>
        </div>
        <div style="overflow-x: auto;">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Μήνας</th>
                <th>Έτος</th>
                <th>Cash (€)</th>
                <th>Etoro (€)</th>
                <th>Revolut (€)</th>
                <th>Winbank (€)</th>
                <th>Stocks (€)</th>
                <th>Youth Pass (€)</th>
                <th>Σύνολο (€)</th>
                <th>Ενέργειες</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Διαγράμματα -->
      <div class="grid">
        <div class="card">
          <h2>Κατανομή Περιουσίας</h2>
          <div class="chart-container">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h2>Εξέλιξη Σύνολου</h2>
          <div class="chart-container">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h2>Σύγκριση Περιουσιακών Στοιχείων</h2>
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Στόχοι -->
      <div class="card">
        <h2>Στόχοι Αγορών</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="goalName">Ονομασία Στόχου</label>
            <input type="text" id="goalName" placeholder="π.χ. Νέο Laptop">
          </div>
          <div class="form-group">
            <label for="goalCost">Κόστος (€)</label>
            <input type="number" id="goalCost" placeholder="0">
          </div>
          <div class="form-group">
            <label for="goalSaved">Μαζεμένα (€)</label>
            <input type="number" id="goalSaved" placeholder="0">
          </div>
          <div class="form-group">
            <label for="goalImage">URL Φωτογραφίας</label>
            <input type="url" id="goalImage" placeholder="https://...">
          </div>

        </div>
        <button onclick="addGoal()" style="margin-top: 15px;">Προσθήκη Στόχου</button>
        
        <div id="goals" style="margin-top: 20px;">
          <!-- Goals will be inserted here dynamically -->
        </div>
      </div>

      <!-- Νέα Ενότητα Διαχείρισης Δανείων -->
      <div class="card">
        <h2>Διαχείριση Δανείων</h2>
        
        <div class="loans-container">
          <!-- Δάνεια που έδωσα -->
          <div class="loan-section">
            <h3>Δάνεια που έδωσα</h3>
            <div class="loan-form">
              <input type="text" id="given-name" placeholder="Όνομα ατόμου">
              <input type="number" id="given-amount" placeholder="Ποσό (€)">
              <input type="date" id="given-date">
              <button onclick="addGivenLoan()">Προσθήκη</button>
            </div>
            <div id="given-list" class="loan-list">
              <!-- Εδώ θα προστεθούν τα δάνεια που έχεις δώσει -->
            </div>
          </div>
          
          <!-- Δάνεια που χρωστάω -->
          <div class="loan-section">
            <h3>Δάνεια που χρωστάω</h3>
            <div class="loan-form">
              <input type="text" id="owed-name" placeholder="Όνομα ατόμου">
              <input type="number" id="owed-amount" placeholder="Ποσό (€)">
              <input type="date" id="owed-date">
              <button onclick="addOwedLoan()">Προσθήκη</button>
            </div>
            <div id="owed-list" class="loan-list">
              <!-- Εδώ θα προστεθούν τα δάνεια που χρωστάς -->
            </div>
          </div>
        </div>
      </div>
      <div class="download-options">
        <button class="download-btn btn-monthly" onclick="downloadMonthlyReport()">📥 Μηνιαία Αναφορά</button>
        <button class="download-btn btn-yearly" onclick="downloadYearlyReport()">📊 Ολική Πορεία Savings</button>
      </div>
    </div>

  </div>

  <script>
    let currentUser = null;
    const USERS_KEY = 'dg_users_v1';
    const CURRENT_USER_KEY = 'dg_current_user_v1';
    function userDataKey(u){ return `dg_data_${u}`; }

    function readUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) || {}; } catch { return {}; } }
    function writeUsers(o){ localStorage.setItem(USERS_KEY, JSON.stringify(o)); }

    async function sha256(str){
      // Fallback όταν δεν υπάρχει secure context (π.χ. file://)
      if (!(window.crypto && window.crypto.subtle)) {
        // απλό djb2 hash (όχι κρυπτογραφικό, απλώς για demo)
        let h = 5381;
        for (let i = 0; i < str.length; i++) h = ((h << 5) + h) ^ str.charCodeAt(i);
        return (h >>> 0).toString(16).padStart(8, '0');
      }
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }


    let financeData = [];
    let goalsData = [];
    let loansGiven = [];
    let loansOwed = [];
    let barChart, lineChart, pieChart;
    let isBlurred = false;

    // Χάρτης μηνών -> αριθμός (ταιριάζει με τα options σου)
    const MONTH_ORDER_MAP = {
      "Ιανουάριος": 1, "Φεβρουάριος": 2, "Μάρτιος": 3, "Απρίλιος": 4,
      "Μάιος": 5, "Ιούνιος": 6, "Ιούλιος": 7, "Αύγουστος": 8,
      "Σεπτέμβριος": 9, "Οκτώβριος": 10, "Νοέμβριος": 11, "Δεκέμβριος": 12
    };

    function monthNameToNumber(name) {
      return MONTH_ORDER_MAP[name] || null;
    }

    function sumAmounts(arr) {
      return arr.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
    }

    function getNetLoansForMonthYear(monthName, year) {
      const m = monthNameToNumber(monthName);
      if (!m) return 0;

      const given = sumAmounts(loansGiven.filter(l => {
        const d = new Date(l.date);
        return d.getFullYear() === +year && (d.getMonth() + 1) === m;
      }));

      const owed = sumAmounts(loansOwed.filter(l => {
        const d = new Date(l.date);
        return d.getFullYear() === +year && (d.getMonth() + 1) === m;
      }));

      return given - owed; // + αν σου χρωστάνε, - αν χρωστάς
    }

    function getNetLoansForYear(year) {
      const given = sumAmounts(loansGiven.filter(l => new Date(l.date).getFullYear() === +year));
      const owed = sumAmounts(loansOwed.filter(l => new Date(l.date).getFullYear() === +year));
      return given - owed;
    }

    // Φόρτωση δεδομένων από localStorage
    function loadData() {
      if(!currentUser) return { financeData: [], goals: [], loansGiven: [], loansOwed: [] };
      const raw = localStorage.getItem(userDataKey(currentUser));
      if (raw) return JSON.parse(raw);
      return { financeData: [], goals: [], loansGiven: [], loansOwed: [] };
    }

    function saveData() {
      if(!currentUser) return;
      const dataToSave = { financeData, goals: goalsData, loansGiven, loansOwed };
      localStorage.setItem(userDataKey(currentUser), JSON.stringify(dataToSave));
    }


    // Φόρτωση δεδομένων κατά την εκκίνηση
    window.addEventListener('DOMContentLoaded', () => {
      wireAuthUI(); // tabs & φόρμες auth
      localStorage.removeItem(CURRENT_USER_KEY);
      const u = localStorage.getItem(CURRENT_USER_KEY);
      if (u) {
        currentUser = u;
        startAppForCurrentUser();
      } else {
        showAuth();
      }
    });

    function showAuth(){
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('appRoot').style.display = 'none';
    }

    function startAppForCurrentUser(){
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('appRoot').style.display = 'block';

      // φόρτωση user data
      const savedData = loadData();
      financeData = savedData.financeData || [];
      goalsData = savedData.goals || [];
      loansGiven = savedData.loansGiven || [];
      loansOwed = savedData.loansOwed || [];

      // --- ΝΕΟ: ανανέωση UI για τον τωρινό χρήστη ---
      refreshTable();
      refreshGoals();
      refreshLoans();
      updateKPIs();
      if (financeData.length === 0) {
        destroyCharts();      // καθάρισε τα charts του προηγούμενου χρήστη
      } else {
        updateCharts();       // φτιάξε charts για τον τωρινό χρήστη
      }
    }

    function destroyCharts(){
      if (pieChart)  { pieChart.destroy();  pieChart = null; }
      if (lineChart) { lineChart.destroy(); lineChart = null; }
      if (barChart)  { barChart.destroy();  barChart = null; }

      // καθάρισε και τα canvases οπτικά
      ['pieChart','lineChart','barChart'].forEach(id => {
        const c = document.getElementById(id);
        if (c) {
          const ctx = c.getContext('2d');
          if (ctx) ctx.clearRect(0, 0, c.width, c.height);
        }
      });
    }


    function wireAuthUI(){
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');

      tabLogin.addEventListener('click', ()=>{
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        loginForm.style.display='block'; signupForm.style.display='none';
      });
      tabSignup.addEventListener('click', ()=>{
        tabSignup.classList.add('active'); tabLogin.classList.remove('active');
        loginForm.style.display='none'; signupForm.style.display='block';
      });

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const username = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value;
        const users = readUsers();
        const rec = users[username];
        if (!rec){ showToast('Λάθος στοιχεία.', 'error'); return; }
        const digest = await sha256(pass);
        if (digest !== rec.pw){ showToast('Λάθος στοιχεία.', 'error'); return; }
        currentUser = username;
        sessionStorage.setItem(CURRENT_USER_KEY, currentUser); // <-- sessionStorage
        startAppForCurrentUser();

      });

      signupForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const username = document.getElementById('signupUser').value.trim();
        const pass = document.getElementById('signupPass').value;
        const pass2 = document.getElementById('signupPass2').value;

        if (username.length < 3){ showToast('Το όνομα χρήστη πρέπει να έχει ≥3 χαρακτήρες.', 'error'); return; }
        if (pass.length < 6){ showToast('Ο κωδικός πρέπει να έχει ≥6 χαρακτήρες.', 'error'); return; }
        if (pass !== pass2){ showToast('Οι κωδικοί δεν ταιριάζουν.', 'error'); return; }

        const users = readUsers();
        if (users[username]){ showToast('Το username υπάρχει ήδη.', 'error'); return; }

        users[username] = { pw: await sha256(pass), createdAt: Date.now() };
        writeUsers(users);

        // φτιάξε empty dataset για τον νέο χρήστη
        localStorage.setItem(userDataKey(username), JSON.stringify({
          financeData: [], goals: [], loansGiven: [], loansOwed: []
        }));

        currentUser = username;
        sessionStorage.setItem(CURRENT_USER_KEY, currentUser);
        startAppForCurrentUser();
      });

      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn){
        logoutBtn.addEventListener('click', ()=>{
          sessionStorage.removeItem(CURRENT_USER_KEY);
          currentUser = null;
          financeData=[]; goalsData=[]; loansGiven=[]; loansOwed=[];
          destroyCharts();
          refreshTable();
          const goalsDiv = document.getElementById('goals'); if (goalsDiv) goalsDiv.innerHTML = '';
          ['given-list','owed-list'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML=''; });
          ['totalKPI','growthKPI','cashKPI','loansKPI'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent='0'; });

          showAuth();
        });
      }
    }
    function refreshGoals() {
      const goalsDiv = document.getElementById("goals");
      goalsDiv.innerHTML = '';

      goalsData.forEach((goal, i) => {
        const percent = goal.cost > 0 ? Math.min((goal.saved / goal.cost) * 100, 100).toFixed(1) : 0;
        const hasImage = goal.image && goal.image.length > 0;

        const item = document.createElement("div");
        item.className = "goal-item";
        item.innerHTML = `
          <div class="goal-header">
            ${hasImage ? `<img class="goal-image" src="${goal.image}" alt="${goal.name}" onerror="this.style.display='none'">` : ``}
            <div>
              <h3 style="margin:0;">${goal.name}</h3>
              <div class="goal-meta">
                Στόχος: <strong>${goal.cost.toFixed(2)}€</strong> |
                Μαζεμένα:
                <input
                  type="number"
                  id="goal-saved-input-${i}"
                  value="${(goal.saved || 0).toFixed(2)}"
                  step="0.01"
                  min="0"
                  max="${goal.cost}"
                  style="width:120px; margin-left:6px;"
                  onchange="setGoalSaved(${i}, this.value)"
                  onkeydown="if(event.key==='Enter'){ setGoalSaved(${i}, this.value) }"
                />
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress" id="goal-progress-${i}" style="width: ${percent}%">${percent}%</div>
          </div>

          <div class="goal-actions" style="margin-top:8px;">
            <button class="btn" onclick="updateGoalImage(${i})">🖼️ Εικόνα</button>
            <button class="btn-delete" onclick="deleteGoal(${i})">🗑️ Διαγραφή</button>
          </div>
        `;

        goalsDiv.appendChild(item);
      });
    }

    function setGoalSaved(index, value) {
      const g = goalsData[index];
      if (!g) return;
      let v = parseFloat(value);
      if (isNaN(v) || v < 0) v = 0;
      if (g.cost > 0) v = Math.min(v, g.cost); // μην ξεπερνά το κόστος

      g.saved = v;
      saveData();
      // ενημέρωση UI (progress bar + input)
      const progEl = document.getElementById(`goal-progress-${index}`);
      const inputEl = document.getElementById(`goal-saved-input-${index}`);
      const percent = g.cost > 0 ? Math.min((g.saved / g.cost) * 100, 100).toFixed(1) : 0;
      if (progEl) { progEl.style.width = `${percent}%`; progEl.textContent = `${percent}%`; }
      if (inputEl) { inputEl.value = g.saved.toFixed(2); }
    }

    function deleteGoal(index) {
      if (!confirm("Σίγουρα θέλεις να διαγράψεις αυτόν τον στόχο;")) return;
      goalsData.splice(index, 1);
      saveData();
      refreshGoals();
    }
    function getNetLoansAll() {
      const given = loansGiven.reduce((s, l) => s + (parseFloat(l.amount) || 0), 0);
      const owed  = loansOwed.reduce((s, l) => s + (parseFloat(l.amount) || 0), 0);
      return given - owed;
    }

    // Αλλαγή/προσθήκη εικόνας στόχου
    function updateGoalImage(index) {
      const url = prompt("Δώσε URL εικόνας (https://...):", goalsData[index].image || "");
      if (url === null) return; // ακύρωση
      goalsData[index].image = (url || "").trim();
      saveData();
      refreshGoals(); // χρειάζεται πλήρες refresh για την εικόνα
    }

    function refreshTable() {
      const tableBody = document.querySelector("#dataTable tbody");
      tableBody.innerHTML = '';
      
      // Sort data by year and month
      const monthOrder = {
        "Ιανουάριος": 1, "Φεβρουάριος": 2, "Μάρτιος": 3, "Απρίλιος": 4,
        "Μάιος": 5, "Ιούνιος": 6, "Ιούλιος": 7, "Αύγουστος": 8,
        "Σεπτέμβριος": 9, "Οκτώβριος": 10, "Νοέμβριος": 11, "Δεκέμβριος": 12
      };
      
      financeData.sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return monthOrder[a.month] - monthOrder[b.month];
      });
      
      financeData.forEach((data, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.month}</td>
          <td>${data.year}</td>
          <td>${data.cash.toFixed(2)}</td>
          <td>${data.etoro.toFixed(2)}</td>
          <td>${data.revolut.toFixed(2)}</td>
          <td>${data.winbank.toFixed(2)}</td>
          <td>${data.stocks.toFixed(2)}</td>
          <td>${(data.youthpass ?? 0).toFixed(2)}</td>
          <td><strong>${data.total.toFixed(2)}</strong></td>
          <td class="action-buttons">
            <button class="btn-delete" onclick="deleteData(${index})">Διαγραφή</button>
            <button class="btn-move" onclick="moveDataUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
            <button class="btn-move" onclick="moveDataDown(${index})" ${index === financeData.length - 1 ? 'disabled' : ''}>↓</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function deleteData(index) {
      if (confirm("Είστε σίγουρος ότι θέλετε να διαγράψετε αυτή την εγγραφή;")) {
        financeData.splice(index, 1);
        // ΑΠΟΘΗΚΕΥΣΗ ΔΕΔΟΜΕΝΩΝ
        saveData();
        refreshTable();
        updateKPIs();
        updateCharts();
      }
    }

    function moveDataUp(index) {
      if (index > 0) {
        [financeData[index], financeData[index - 1]] = [financeData[index - 1], financeData[index]];
        // ΑΠΟΘΗΚΕΥΣΗ ΔΕΔΟΜΕΝΩΝ
        saveData();
        refreshTable();
        updateCharts();
      }
    }

    function moveDataDown(index) {
      if (index < financeData.length - 1) {
        [financeData[index], financeData[index + 1]] = [financeData[index + 1], financeData[index]];
        // ΑΠΟΘΗΚΕΥΣΗ ΔΕΔΟΜΕΝΩΝ
        saveData();
        refreshTable();
        updateCharts();
      }
    }


    function updateKPIs() {
      if (financeData.length < 1) return;

      const latest = financeData[financeData.length - 1];
      const prev = financeData.length > 1 ? financeData[financeData.length - 2] : null;

      // Συνολικά καθαρά δάνεια (όλα τα χρόνια)
      const netLoans = getNetLoansAll();
      const effectiveLatest = latest.total + netLoans;

      let growthPct = 0;
      if (prev) {
        const effectivePrev = prev.total + netLoans; // ίδια καθαρά δάνεια και για τα 2 ⇒ growth πάνω στις καταγραφές
        growthPct = effectivePrev > 0 ? ((effectiveLatest - effectivePrev) / effectivePrev * 100) : 0;
      }

      const cashPercent = effectiveLatest > 0 ? ((latest.cash / effectiveLatest) * 100) : 0;

      document.getElementById("totalKPI").textContent = `${effectiveLatest.toFixed(2)}€`;
      const growthElement = document.getElementById("growthKPI");
      growthElement.textContent = `${growthPct.toFixed(2)}%`;
      growthElement.className = `kpi-value ${growthPct >= 0 ? 'positive' : 'negative'}`;
      document.getElementById("cashKPI").textContent = `${cashPercent.toFixed(1)}%`;

      const loansEl = document.getElementById("loansKPI");
      if (loansEl) {
        const sign = netLoans >= 0 ? "+" : "";
        loansEl.textContent = `${sign}${netLoans.toFixed(2)}€`;
        loansEl.className = `kpi-value ${netLoans >= 0 ? 'positive' : 'negative'}`;
      }
    }




    function updateCharts() {
        if (financeData.length === 0) { destroyCharts(); return; }

        setLoadingState(true);

        setTimeout(() => {
            const labels = financeData.map(d => `${d.month} ${d.year}`);
            const cashData = financeData.map(d => d.cash);
            const etoroData = financeData.map(d => d.etoro);
            const revolutData = financeData.map(d => d.revolut);
            const winbankData = financeData.map(d => d.winbank);
            const stocksData = financeData.map(d => d.stocks);
            const totalsData = financeData.map(d => d.total);
            const youthpassData = financeData.map(d => d.youthpass ?? 0);


            const latest = financeData[financeData.length - 1];
            const pieData = [
              latest.cash,
              latest.etoro,
              latest.revolut,
              latest.winbank,
              latest.stocks,
              (latest.youthpass ?? 0)
            ];

            // Καταστροφή παλιών charts
            if (pieChart) pieChart.destroy();
            if (lineChart) lineChart.destroy();
            if (barChart) barChart.destroy();

            // Δημιουργία Pie Chart
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: ['Cash', 'Etoro', 'Revolut', 'Winbank', 'Stocks', 'Youth Pass'],
                    datasets: [{
                        data: pieData,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#34495e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Δημιουργία Line Chart
            lineChart = new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Σύνολο',
                        data: totalsData,
                        borderColor: '#3498db',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Δημιουργία Bar Chart
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cash',
                            data: cashData,
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'Etoro',
                            data: etoroData,
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'Revolut',
                            data: revolutData,
                            backgroundColor: '#e74c3c'
                        },
                        {
                            label: 'Winbank',
                            data: winbankData,
                            backgroundColor: '#f39c12'
                        },
                        {
                            label: 'Stocks',
                            data: stocksData,
                            backgroundColor: '#9b59b6'
                        },
                        {
                            label: 'Youth Pass',
                            data: youthpassData,
                            backgroundColor: '#34495e'
                        }
                        
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });

            setTimeout(addChartInteractions, 500);
            setLoadingState(false);
        }, 300);
        }


    function addChartInteractions() {
        const charts = [pieChart, lineChart, barChart];
        
        charts.forEach(chart => {
            if (!chart) return;
            
            const canvas = chart.canvas;
            canvas.style.cursor = 'pointer';
            canvas.title = 'Κάντε κλικ για λεπτομέρειες';
        });
    }
    function addGoal() {
      const name = document.getElementById("goalName").value;
      const cost = parseFloat(document.getElementById("goalCost").value) || 0;
      const saved = parseFloat(document.getElementById("goalSaved").value) || 0;
      const image = (document.getElementById("goalImage").value || "").trim(); // <-- ΝΕΟ

      if (!name || cost <= 0) {
        alert("Παρακαλώ συμπληρώστε το όνομα και το κόστος του στόχου.");
        return;
      }

      goalsData.push({ name, cost, saved, image }); // <-- αποθήκευση εικόνας

      saveData();
      refreshGoals();

      // clear
      document.getElementById("goalName").value = "";
      document.getElementById("goalCost").value = "";
      document.getElementById("goalSaved").value = "";
      document.getElementById("goalImage").value = ""; // <-- καθάρισμα πεδίου εικόνας
    }


    // Συναρτήσεις για τα δάνεια
    function addGivenLoan() {      const name = document.getElementById("given-name").value;
      const amount = parseFloat(document.getElementById("given-amount").value) || 0;
      const date = document.getElementById("given-date").value;
      
      if (name && amount && date) {
        loansGiven.push({ name, amount, date });
        
        // ΑΠΟΘΗΚΕΥΣΗ ΔΕΔΟΜΕΝΩΝ
        saveData();
        
        refreshLoans();
        updateKPIs(); 
        // Clear form fields
        document.getElementById("given-name").value = "";
        document.getElementById("given-amount").value = "";
        document.getElementById("given-date").value = "";
      } else {
        alert("Συμπλήρωσε όλα τα πεδία!");
      }
    }

    function addOwedLoan() {
      const name = document.getElementById("owed-name").value;
      const amount = parseFloat(document.getElementById("owed-amount").value) || 0;
      const date = document.getElementById("owed-date").value;
      
      if (name && amount && date) {
        loansOwed.push({ name, amount, date });
        
        // ΑΠΟΘΗΚΕΥΣΗ ΔΕΔΟΜΕΝΩΝ
        saveData();
        
        refreshLoans();
        updateKPIs(); 
        // Clear form fields
        document.getElementById("owed-name").value = "";
        document.getElementById("owed-amount").value = "";
        document.getElementById("owed-date").value = "";
      } else {
        alert("Συμπλήρωσε όλα τα πεδία!");
      }
    }

    function refreshLoans() {
      const givenList = document.getElementById("given-list");
      const owedList = document.getElementById("owed-list");
      
      givenList.innerHTML = '';
      owedList.innerHTML = '';
      
      // Προσθήκη δανείων που έδωσες
      loansGiven.forEach((loan, index) => {
        const loanItem = document.createElement("div");
        loanItem.className = "loan-item";
        loanItem.innerHTML = `
          <strong>${loan.name}</strong>: ${loan.amount.toFixed(2)}€ (${new Date(loan.date).toLocaleDateString('el-GR')})
          <button class="btn-delete" onclick="deleteGivenLoan(${index})">Διαγραφή</button>
        `;
        givenList.appendChild(loanItem);
      });
      
      // Προσθήκη δανείων που χρωστάς
      loansOwed.forEach((loan, index) => {
        const loanItem = document.createElement("div");
        loanItem.className = "loan-item";
        loanItem.innerHTML = `
          <strong>${loan.name}</strong>: ${loan.amount.toFixed(2)}€ (${new Date(loan.date).toLocaleDateString('el-GR')})
          <button class="btn-delete" onclick="deleteOwedLoan(${index})">Διαγραφή</button>
        `;
        owedList.appendChild(loanItem);
      });
    }

    function deleteGivenLoan(index) {
      if (confirm("Είστε σίγουρος ότι θέλετε να διαγράψετε αυτό το δάνειο;")) {
        loansGiven.splice(index, 1);
        saveData();
        refreshLoans();
        updateKPIs(); 
      }
    }

    function deleteOwedLoan(index) {
      if (confirm("Είστε σίγουρος ότι θέλετε να διαγράψετε αυτό το δάνειο;")) {
        loansOwed.splice(index, 1);
        saveData();
        refreshLoans();
        updateKPIs(); 
      }
    }

    async function downloadMonthlyReport() {
      if (financeData.length === 0) { alert("Δεν υπάρχουν δεδομένα για αναφορά."); return; }

      const latest = financeData[financeData.length - 1];
      const netLoans = getNetLoansAll();
      const totalWithLoans = latest.total + netLoans;

      // εικόνες από τα υπάρχοντα charts της σελίδας
      let pieImg = chartToImage(pieChart);
      let lineImg = chartToImage(lineChart);

      // αν για κάποιο λόγο δεν υπάρχουν, φτιάξ’ τα προσωρινά
      if (!pieImg) {
        pieImg = await makeChartImage('doughnut', {
          labels: ['Cash','Etoro','Revolut','Winbank','Stocks','Youth Pass'],
          datasets: [{ data: [latest.cash, latest.etoro, latest.revolut, latest.winbank, latest.stocks, (latest.youthpass ?? 0)],
            backgroundColor: ['#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6','#334155'] }]
        }, { plugins: { legend: { position: 'bottom' } } }, 900, 340);
      }
      if (!lineImg) {
        const labels = financeData.map(d => `${d.month} ${d.year}`);
        const totals = financeData.map(d => d.total);
        lineImg = await makeChartImage('line', {
          labels,
          datasets: [{ label:'Σύνολο', data: totals, borderColor:'#2563eb', tension:0.2 }]
        }, { plugins:{legend:{display:false}} }, 900, 300);
      }

      const content = `
        ${pdfStyles()}
        <div class="pdf">
          <h1>Μηνιαία Οικονομική Αναφορά</h1>
          <div class="period">${latest.month} ${latest.year}</div>

          <div class="summary">
            <h2>Σύνοψη</h2>
            <p><strong>Συνολικό Πορτοφόλι (χωρίς Δάνεια):</strong> ${latest.total.toFixed(2)}€</p>
            <p><strong>Καθαρά Δάνεια:</strong> ${netLoans >= 0 ? '+' : ''}${netLoans.toFixed(2)}€</p>
            <p><strong>Σύνολο (με Δάνεια):</strong> ${totalWithLoans.toFixed(2)}€</p>
            <ul style="margin-top:8px;">
              <li>Cash: ${latest.cash.toFixed(2)}€</li>
              <li>Etoro: ${latest.etoro.toFixed(2)}€</li>
              <li>Revolut: ${latest.revolut.toFixed(2)}€</li>
              <li>Winbank: ${latest.winbank.toFixed(2)}€</li>
              <li>Stocks: ${latest.stocks.toFixed(2)}€</li>
              <li>Youth Pass: ${(latest.youthpass ?? 0).toFixed(2)}€</li>
            </ul>
          </div>

          <h2>Διαγράμματα</h2>
          <div class="charts">
            <img alt="Κατανομή Περιουσίας" src="${pieImg}">
            <img alt="Εξέλιξη Σύνολου" src="${lineImg}">
          </div>

          <h2>Λεπτομερής Κατάσταση</h2>
          <table>
            <tr><th>Πηγή</th><th>Ποσό (€)</th><th>Ποσοστό</th></tr>
            <tr><td>Cash</td><td>${latest.cash.toFixed(2)}</td><td>${((latest.cash / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td>Etoro</td><td>${latest.etoro.toFixed(2)}</td><td>${((latest.etoro / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td>Revolut</td><td>${latest.revolut.toFixed(2)}</td><td>${((latest.revolut / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td>Winbank</td><td>${latest.winbank.toFixed(2)}</td><td>${((latest.winbank / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td>Stocks</td><td>${latest.stocks.toFixed(2)}</td><td>${((latest.stocks / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td>Youth Pass</td><td>${(latest.youthpass ?? 0).toFixed(2)}</td><td>${(((latest.youthpass ?? 0) / latest.total) * 100).toFixed(1)}%</td></tr>
            <tr><td><strong>Καθαρά Δάνεια</strong></td><td colspan="2"><strong>${netLoans >= 0 ? '+' : ''}${netLoans.toFixed(2)}€</strong></td></tr>
            <tr><td><strong>Σύνολο (με Δάνεια)</strong></td><td colspan="2"><strong>${totalWithLoans.toFixed(2)}€</strong></td></tr>
          </table>
        </div>
      `;

      generatePDF(content, `SAVINGS ~ ${latest.month}_${latest.year}.pdf`);
    }



    async function downloadYearlyReport() {
      if (financeData.length === 0) { alert("Δεν υπάρχουν δεδομένα για εξαγωγή αναφοράς."); return; }

      // Ομαδοποίηση ανά έτος
      const dataByYear = {};
      financeData.forEach(item => (dataByYear[item.year] ||= []).push(item));

      const selectedYear = document.getElementById("year").value;
      const yearData = (dataByYear[selectedYear] || []).slice().sort((a,b) => {
        return (MONTH_ORDER_MAP[a.month]||0) - (MONTH_ORDER_MAP[b.month]||0);
      });
      if (yearData.length === 0) { alert(`Δεν υπάρχουν δεδομένα για το έτος ${selectedYear}`); return; }

      // Σύνολα
      const yearlyTotal = yearData.reduce((s,d)=>s+d.total,0);
      const prevYear = String(+selectedYear - 1);
      const prevYearData = (dataByYear[prevYear] || []);
      const prevYearTotal = prevYearData.reduce((s,d)=>s+d.total,0);

      // Δάνεια
      const netLoansYear = getNetLoansForYear(+selectedYear);
      const yearlyTotalWithLoans = yearlyTotal + netLoansYear;
      const prevYearNetLoans = getNetLoansForYear(+prevYear);
      const prevYearTotalWithLoans = prevYearTotal + prevYearNetLoans;
      const growthYearPct = prevYearTotalWithLoans > 0
        ? (((yearlyTotalWithLoans - prevYearTotalWithLoans) / prevYearTotalWithLoans) * 100).toFixed(2)
        : 0;

      // Charts μόνο για το επιλεγμένο έτος
      const labels = yearData.map(d => d.month);
      const totals  = yearData.map(d => d.total);

      const yearLineImg = await makeChartImage('line', {
        labels,
        datasets: [{ label: `Σύνολο ${selectedYear}`, data: totals, borderColor:'#2563eb', tension:0.2 }]
      }, { plugins:{legend:{display:false}} }, 900, 300);

      const categories = ['cash','etoro','revolut','winbank','stocks','youthpass'];
      const catTotals = categories.map(c => yearData.reduce((s,d) => s + (+d[c]||0), 0));
      const catLabels = ['Cash','Etoro','Revolut','Winbank','Stocks','Youth Pass'];
      const distImg = await makeChartImage('doughnut', {
        labels: catLabels,
        datasets: [{ data: catTotals, backgroundColor:['#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6','#334155'] }]
      }, { plugins:{ legend:{ position:'bottom' } } }, 900, 340);

      let content = `
        ${pdfStyles()}
        <div class="pdf">
          <h1>Ολική Πορεία Savings</h1>
          <div class="period">Έτος ${selectedYear}</div>

          <div class="summary">
            <h2>Σύνοψη Έτους</h2>
            <p><strong>Συνολικό Πορτοφόλι (χωρίς Δάνεια):</strong> ${yearlyTotal.toFixed(2)}€</p>
            <p><strong>Καθαρά Δάνεια (έτους):</strong> ${netLoansYear >= 0 ? '+' : ''}${netLoansYear.toFixed(2)}€</p>
            <p><strong>Σύνολο (με Δάνεια):</strong> ${yearlyTotalWithLoans.toFixed(2)}€</p>
            <p><strong>Μεταβολή από ${prevYear} (με Δάνεια):</strong> ${growthYearPct}%</p>
          </div>

          <h2>Διαγράμματα</h2>
          <div class="charts">
            <img alt="Εξέλιξη Σύνολου ${selectedYear}" src="${yearLineImg}">
            <img alt="Κατανομή Περιουσίας ${selectedYear}" src="${distImg}">
          </div>

          <h2>Μηνιαία Στοιχεία</h2>
          <table>
            <tr>
              <th>Μήνας</th><th>Cash (€)</th><th>Etoro (€)</th><th>Revolut (€)</th>
              <th>Winbank (€)</th><th>Stocks (€)</th><th>Youth Pass (€)</th><th>Σύνολο (€)</th>
            </tr>
      `;

      yearData.forEach(d => {
        content += `
          <tr>
            <td>${d.month}</td>
            <td>${d.cash.toFixed(2)}</td>
            <td>${d.etoro.toFixed(2)}</td>
            <td>${d.revolut.toFixed(2)}</td>
            <td>${d.winbank.toFixed(2)}</td>
            <td>${d.stocks.toFixed(2)}</td>
            <td>${(d.youthpass ?? 0).toFixed(2)}</td>
            <td><strong>${d.total.toFixed(2)}</strong></td>
          </tr>`;
      });

      // σύνολα κατηγοριών & μέσο ποσοστό
      const categoryAverages = catTotals.map(t => yearlyTotal > 0 ? (t/yearlyTotal*100).toFixed(1) : '0.0');
      content += `
          </table>

          <h2>Συνολικές Κατανομές για το ${selectedYear}</h2>
          <table>
            <tr><th>Πηγή</th><th>Συνολικό Ποσό (€)</th><th>Μέσο Ποσοστό</th></tr>
      `;
      for (let i=0;i<categories.length;i++){
        content += `<tr><td>${catLabels[i]}</td><td>${catTotals[i].toFixed(2)}</td><td>${categoryAverages[i]}%</td></tr>`;
      }
      content += `</table></div>`;

      generatePDF(content, `SAVINGS ~ ${selectedYear}.pdf`);
    }

    // --- PDF helpers ---
    function pdfStyles() {
      return `
      <style>
        :root { color-scheme: light; } /* force light in PDF */
        .pdf { padding:16px; background:#ffffff; font-family: 'Inter','Segoe UI',sans-serif; color:#1f2937; }
        .pdf h1{ text-align:center; color:#0f172a; margin:0 0 8px; }
        .period{ text-align:center; margin-bottom:18px; font-style:italic; color:#475569; }
        .summary{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:14px 0 20px; }
        h2{ color:#0f172a; border-bottom:1px solid #e5e7eb; padding-bottom:6px; margin:18px 0 10px; }
        table{ width:100%; border-collapse:collapse; font-size:12px; }
        th,td{ border:1px solid #e5e7eb; padding:8px; text-align:center; background:#ffffff; }
        th{ background:#f1f5f9; }
        .charts img{ width:100%; height:auto; margin:8px 0 14px; display:block; }
      </style>`;
    }

    // Αν έχεις ήδη charts στην σελίδα, πάρε κατευθείαν εικόνα:
    function chartToImage(chartInstance) {
      try { return chartInstance ? chartInstance.toBase64Image() : ''; } catch { return ''; }
    }

    // Δημιούργησε "προσωρινό" chart μόνο για το PDF και πάρε εικόνα
    async function makeChartImage(type, data, options = {}, w = 900, h = 360) {
      return new Promise(resolve => {
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.style.position = 'fixed';
        canvas.style.left = '-10000px';
        canvas.style.top = '-10000px';
        document.body.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, {
          type,
          data,
          options: Object.assign({
            responsive: false,
            animation: false,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
          }, options)
        });

        // δώσε 1 tick για render
        setTimeout(() => {
          const url = canvas.toDataURL('image/png');
          chart.destroy();
          canvas.remove();
          resolve(url);
        }, 100);
      });
    }

    function generatePDF(content, filename) {
      const element = document.createElement('div');
      element.innerHTML = content;
      
      const opt = {
        margin: 0.5,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      
      html2pdf().set(opt).from(element).save();
    }
    // Λειτουργία εναλλαγής θέματος
    const themeToggle = document.getElementById('themeToggle');
    const themeOptions = document.getElementById('themeOptions');
    const body = document.body;

    // Έλεγχος για αποθηκευμένη προτίμηση θέματος
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Χειρισμός κλικ στο κουμπί αλλαγής θέματος
    themeToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    themeOptions.classList.toggle('show');
    });

    // Κλείσιμο του menu όταν γίνεται κλικ έξω από αυτό
    document.addEventListener('click', (e) => {
    if (!themeToggle.contains(e.target) && !themeOptions.contains(e.target)) {
        themeOptions.classList.remove('show');
    }
    });

    // Χειρισμός επιλογής θέματος
    document.querySelectorAll('.theme-option').forEach(option => {
    option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeOptions.classList.remove('show');
        updateThemeIcon(theme);
        updateCharts();
    });
    });

    function updateThemeIcon(theme) {
    const icons = {
        'light': '☀️',
        'dark': '🌙',
        'purple': '🎨'
    };
    themeToggle.textContent = icons[theme];
        }
        // Συνάρτηση για εμφάνιση toast notifications
    function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = type === 'success' ? 'var(--success)' : 'var(--accent)';
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
    }

    // Συνάρτηση για loading state
    function setLoadingState(isLoading) {
    const loader = document.getElementById('loadingIndicator');
    const charts = document.querySelectorAll('.chart-container');
    
    if (isLoading) {
        loader.style.display = 'block';
        charts.forEach(chart => chart.classList.add('loading'));
    } else {
        loader.style.display = 'none';
        charts.forEach(chart => chart.classList.remove('loading'));
    }
    }

    // Βελτιωμένη addData με loading state και feedback
    async function addData() {
    setLoadingState(true);

    try {
        const month = document.getElementById("month").value;
        const year = document.getElementById("year").value;
        const cash = parseFloat(document.getElementById("cash").value) || 0;
        const etoro = parseFloat(document.getElementById("etoro").value) || 0;
        const revolut = parseFloat(document.getElementById("revolut").value) || 0;
        const winbank = parseFloat(document.getElementById("winbank").value) || 0;
        const stocks = parseFloat(document.getElementById("stocks").value) || 0;
        const youthpass = parseFloat(document.getElementById("youthpass").value) || 0;

        // Validation
        if ([cash, etoro, revolut, winbank, stocks, youthpass].some(v => v < 0)) {
        showToast('Οι τιμές δεν μπορούν να είναι αρνητικές', 'error');
        setLoadingState(false);
        return;
        }

        const total = cash + etoro + revolut + winbank + stocks + youthpass;

        const existingIndex = financeData.findIndex(d => 
        d.month.toLowerCase() === month.toLowerCase() && d.year === year
        );

        if (existingIndex !== -1) {
        financeData[existingIndex] = {month, year, cash, etoro, revolut, winbank, stocks, youthpass, total};
        } else {
        financeData.push({month, year, cash, etoro, revolut, winbank, stocks, youthpass, total});
        }

        saveData();
        refreshTable();
        updateKPIs();
        updateCharts();
        showToast('Τα δεδομένα αποθηκεύτηκαν επιτυχώς!');
    } catch (error) {
        showToast('Σφάλμα κατά την αποθήκευση των δεδομένων', 'error');
    } finally {
        setLoadingState(false);
    }
    }


    // Λειτουργία αναζήτησης και φιλτραρίσματος
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('yearFilter').addEventListener('change', filterTable);

    function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;
    const rows = document.querySelectorAll('#dataTable tbody tr');
    
    rows.forEach(row => {
        const month = row.cells[0].textContent.toLowerCase();
        const year = row.cells[1].textContent;
        
        const matchesSearch = month.includes(searchText);
        const matchesYear = !yearFilter || year === yearFilter;
        
        row.style.display = (matchesSearch && matchesYear) ? '' : 'none';
    });
    }
        // Λειτουργία απόκρυψης/προβολής δεδομένων
        // Αντικατάσταση της συνάρτησης togglePrivacy
    function togglePrivacy() {
        // Κάνε blur μόνο τα νούμερα στα KPIs
        const kpiValues = document.querySelectorAll('.kpi-value');
        
        // Κάνε blur μόνο τα νούμερα στον πίνακα δεδομένων (όλες οι στήλες εκτός από μήνα, έτος και ενέργειες)
        const dataTable = document.getElementById('dataTable');
        const rows = dataTable.querySelectorAll('tbody tr');
        
        kpiValues.forEach(element => {
            if (isBlurred) {
                element.classList.add('blur-numbers');
            } else {
                element.classList.remove('blur-numbers');
            }
        });
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            // Κάνε blur όλα τα κελιά εκτός από το πρώτο (μήνας), δεύτερο (έτος) και τελευταίο (ενέργειες)
            for (let i = 2; i < cells.length - 1; i++) {
                if (isBlurred) {
                    cells[i].classList.add('blur-numbers');
                } else {
                    cells[i].classList.remove('blur-numbers');
                }
            }
        });
        
        // Αλλαγή εικονιδίου
        const privacyButton = document.getElementById('privacyToggle');
        privacyButton.textContent = isBlurred ? '🔒' : '👁️';
        privacyButton.setAttribute('data-tooltip', isBlurred ? 'Εμφάνιση δεδομένων' : 'Απόκρυψη δεδομένων');
        
        // Αποθήκευση της προτίμησης
        localStorage.setItem('privacyMode', isBlurred);
    }
        // Προσθήκη event listener για το κουμπί απόκρυψης
    document.getElementById('privacyToggle').addEventListener('click', function() {
        isBlurred = !isBlurred;
        togglePrivacy();
    });

    // Έλεγχος για αποθηκευμένη προτίμηση κατά τη φόρτωση
    const savedPrivacyMode = localStorage.getItem('privacyMode') === 'true';
    if (savedPrivacyMode) {
        isBlurred = true;
        // Χρησιμοποιούμε setTimeout για να εφαρμοστεί μετά τη φόρτωση της σελίδας
        setTimeout(togglePrivacy, 100);
    }
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").then(() => {
        console.log("Service Worker registered ✅");
      }).catch(err => console.error("SW error:", err));
    }
  </script>
  </body>
</html>